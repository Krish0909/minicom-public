<!DOCTYPE html>
<html>
<head>
    <title>Customer Support Chat</title>
    <style>
        /* Minimal styling for clean chat interface */
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        #chat-container { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; background: #f9f9f9; }
        .message { margin: 10px 0; padding: 8px; border-radius: 5px; }
        .customer { background: #e3f2fd; text-align: right; }
        .bot { background: #fff3e0; }
        .agent { background: #e8f5e9; }
        #message-form { margin-top: 10px; display: flex; }
        #message-input { flex: 1; padding: 10px; border: 1px solid #ccc; }
        #send-btn { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        #send-btn:hover { background: #0056b3; }
        .sender-label { font-weight: bold; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <h2>Customer Support Chat</h2>
    <p>Customer ID: <span id="customer-id">{{ customer_id }}</span></p>

    <!-- Chat message display area -->
    <div id="chat-container"></div>

    <!-- Message input form -->
    <form id="message-form">
        <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" required>
        <button type="submit" id="send-btn">Send</button>
    </form>

    <script>
        // Get customer ID from template
        const customerId = "{{ customer_id }}";

        // Establish WebSocket connection for real-time messaging
        const socket = new WebSocket(`ws://${window.location.host}/ws/chat/${customerId}/`);

        socket.onopen = function(e) {
            console.log('WebSocket connected');
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            // Handle message history (sent on connect)
            if (data.type === 'history') {
                data.messages.forEach(msg => {
                    displayMessage(msg.sender, msg.content);
                });
            }

            // Handle new messages
            if (data.type === 'message') {
                displayMessage(data.sender, data.message);
            }
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        socket.onclose = function(e) {
            console.log('WebSocket closed');
        };

        // Display a message in the chat container
        function displayMessage(sender, content) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const label = document.createElement('div');
            label.className = 'sender-label';
            label.textContent = sender.toUpperCase();

            const text = document.createElement('div');
            text.textContent = content;

            messageDiv.appendChild(label);
            messageDiv.appendChild(text);
            chatContainer.appendChild(messageDiv);

            // Auto-scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Send message when form is submitted
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (message) {
                // Send message via WebSocket
                socket.send(JSON.stringify({
                    'message': message
                }));

                // Clear input
                input.value = '';
            }
        });
    </script>
</body>
</html>
